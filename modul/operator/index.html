<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Operator - Garda Kota</title>
</head>
<body>
    <div class="app-header">
        <div style="font-weight:bold;"><i class="fas fa-user-circle"></i> OPERATOR PANEL</div>
        <i class="fas fa-sign-out-alt" onclick="localStorage.clear(); window.location.href='../admin/login.html'"></i>
    </div>
    <div class="container">
        <div class="card" style="background:#e8f5e9; border:1px solid #2e7d32;">
            <small>Petugas:</small><h4 id="u-name" style="margin:0;">-</h4>
        </div>
        <div class="card">
            <label>Kategori</label>
            <select id="kat"><option>Drainase/Banjir</option><option>Sampah Liar</option><option>Kebakaran</option><option>Kamtibmas</option></select>
            <textarea id="ket" placeholder="Deskripsikan kejadian..."></textarea>
            <div id="gps" style="background:#eee; padding:10px; border-radius:10px; font-size:11px; margin-bottom:10px;">üìç Lokasi GPS Belum Dikunci</div>
            <button class="btn-main" style="background:#0288d1; margin-bottom:10px;" onclick="getGps()">KUNCI LOKASI</button>
            <input type="file" id="foto" accept="image/*" capture="camera">
            <button class="btn-main" id="btn" style="margin-top:10px;" onclick="kirim()">üöÄ KIRIM LAPORAN CEPAT</button>
        </div>
    </div>
    <script>
        const label = localStorage.getItem("user_label");
        if(!label || localStorage.getItem("role")!=="operator") window.location.href="../admin/login.html";
        document.getElementById('u-name').innerText = label;

        let lat="", lng="";
        function getGps(){
            navigator.geolocation.getCurrentPosition(p => {
                lat=p.coords.latitude; lng=p.coords.longitude;
                document.getElementById('gps').innerText = "‚úÖ LOKASI TERKUNCI";
            });
        }

        async function kirim(){
            const f = document.getElementById('foto').files[0];
            if(!f || !lat) return alert("Foto dan GPS Wajib!");
            document.getElementById('btn').innerText = "‚åõ Mengirim...";
            
            let fd = new FormData(); fd.append("image", f);
            let rI = await fetch("https://api.imgbb.com/1/upload?key=2e07237050e6690770451ded20f761b5", {method:"POST", body:fd});
            let dI = await rI.json();
            
            await fetch('https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec', {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ nama:label, kategori:document.getElementById('kat').value, keterangan:document.getElementById('ket').value, lokasi:`http://maps.google.com/maps?q=${lat},${lng}`, foto:dI.data.url })
            });
            alert("Berhasil!"); window.location.reload();
        }
    </script>
</body>
</html>
