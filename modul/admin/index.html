<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Command Center</title>
</head>
<body>
    <div class="app-header">
        <div style="font-weight:bold;">COMMAND CENTER</div>
        <i class="fas fa-power-off" onclick="localStorage.clear(); window.location.href='login.html'"></i>
    </div>
    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;"><i class="fas fa-clock-rotate-left"></i> Aktivitas Petugas</h4>
                <small id="log-count">0 Aktivitas</small>
            </div>
            <div id="log-list" style="font-size:11px; color:#666; max-height:80px; overflow-y:auto;"></div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0;"><i class="fas fa-tasks"></i> Workflow Laporan</h4>
                <button onclick="window.print()" class="btn-main" style="width:auto; padding:5px 10px; font-size:10px;">Cetak</button>
            </div>
            <div id="list">Memuat Data...</div>
        </div>
    </div>
    <script>
        if(localStorage.getItem("role")!=="admin") window.location.href="login.html";
        async function load(){
            const r = await fetch('https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec');
            const d = await r.json();
            
            // Render Logs
            let lH = "";
            d.logs.reverse().slice(0,10).forEach(l => { lH += `<div>[${new Date(l[0]).toLocaleTimeString()}] ${l[1]} Login</div>`; });
            document.getElementById('log-list').innerHTML = lH;
            document.getElementById('log-count').innerText = d.logs.length + " Total";

            // Render Workflow
            let html = "";
            d.laporan.reverse().forEach((i, idx) => {
                if(idx === d.laporan.length - 1) return;
                html += `<div class="card" style="padding:10px; border-left:5px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between;">
                        <small>${i[1]}</small>
                        <span class="badge b-${i[6].toLowerCase()}">${i[6]}</span>
                    </div>
                    <p style="font-size:12px; margin:5px 0;">${i[3]}</p>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <button class="btn-main" style="flex:1; padding:5px; font-size:10px; background:#0288d1" onclick="upd('${i[0]}','Verifikasi')">VERIF</button>
                        <button class="btn-main" style="flex:1; padding:5px; font-size:10px; background:#ff9800" onclick="upd('${i[0]}','Penanganan')">TANGANI</button>
                        <button class="btn-main" style="flex:1; padding:5px; font-size:10px; background:#388e3c" onclick="upd('${i[0]}','Selesai')">DONE</button>
                        <a href="${i[5]}" target="_blank" class="btn-main" style="flex:0.5; padding:5px; font-size:10px; background:#444"><i class="fas fa-image"></i></a>
                    </div>
                </div>`;
            });
            document.getElementById('list').innerHTML = html;
        }
        async function upd(ts, st){
            if(!confirm("Proses ke "+st+"?")) return;
            await fetch('https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec', { method:'POST', mode:'no-cors', body: JSON.stringify({ action:'updateStatus', id:ts, status:st }) });
            alert("Status Diperbarui!"); window.location.reload();
        }
        load();
    </script>
</body>
</html>
