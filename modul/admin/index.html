<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Command Center - GARDA DUMAI KOTA</title>
    <style>
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .bg-wait { background: #ffdada; color: #c0392b; }
        .bg-pro { background: #fff3cd; color: #856404; }
        .bg-done { background: #d4edda; color: #155724; }
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 6px; transition: 0.2s; color: white; margin-right: 2px; }
        button:hover { opacity: 0.8; }
        .btn-map { background: #3498db; }
        .btn-pro { background: #f1c40f; color: #333; }
        .btn-done { background: #2ecc71; }
        .btn-del { background: #e74c3c; }
    </style>
</head>
<body style="background:#f4f7f6; margin:0; font-family:sans-serif;">
    <div style="background:#1a1a1a; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h1 style="font-size:16px; margin:0;">COMMAND CENTER | <span id="userDisplay">ADMIN</span></h1>
        <button onclick="logout()" style="background:#c0392b; border-radius:4px; padding:6px 12px;">Logout</button>
    </div>

    <div style="padding: 20px; max-width: 1200px; margin: auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #1a1a1a; margin-bottom:15px; padding-bottom:10px;">
            <h2 style="margin:0; font-weight:800;">REKAPITULASI LAPORAN</h2>
            <div id="countBadge" style="background:#e74c3c; color:white; padding:5px 15px; border-radius:20px; font-weight:bold;">0</div>
        </div>
        
        <div style="background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow-x: auto;">
            <table style="width:100%; border-collapse:collapse; min-width:950px;">
                <thead>
                    <tr style="background:#2c3e50; color:white; text-align:left;">
                        <th style="padding:15px;">WAKTU</th>
                        <th style="padding:15px;">JENIS & PETUGAS</th>
                        <th style="padding:15px;">WILAYAH / KETERANGAN</th>
                        <th style="padding:15px;">STATUS</th>
                        <th style="padding:15px; text-align:center;">KONTROL AKSI</th>
                    </tr>
                </thead>
                <tbody id="laporanBody">
                    <tr><td colspan="5" style="text-align:center; padding:50px;">Memuat Data Database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="../aksi/auth.js"></script>
    <script>
        const SAKTI = "https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec";
        
        // 1. Jalankan Satpam & Set Nama
        if(typeof proteksiHalaman === 'function') proteksiHalaman('admin');
        document.getElementById("userDisplay").innerText = "Halo, " + (localStorage.getItem("user_label") || "ADMIN");

        function logout() {
            if(confirm("Yakin ingin keluar?")) {
                localStorage.clear();
                window.location.href = "login.html";
            }
        }

        // 2. Load Data (PASTI JALAN)
        async function loadLaporan() {
            const tbody = document.getElementById("laporanBody");
            try {
                const res = await fetch(SAKTI);
                const data = await res.json();
                const items = data.laporan;
                
                document.getElementById("countBadge").innerText = items.length;
                tbody.innerHTML = ""; 

                items.reverse().forEach((lap, index) => {
                    const realID = items.length - index; // ID Baris di Sheets
                    const st = lap[6] || "Menunggu";
                    
                    let stClass = "bg-wait";
                    if(st === "Proses") stClass = "bg-pro";
                    if(st === "Selesai") stClass = "bg-done";

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding:15px;"><small>${lap[0]}</small></td>
                            <td style="padding:15px;"><b>${lap[2]}</b><br><small>${lap[1]}</small></td>
                            <td style="padding:15px;"><div style="color:#2e7d32; font-weight:bold; font-size:12px;">${lap[4]}</div></td>
                            <td style="padding:15px;"><span class="badge ${stClass}">${st}</span></td>
                            <td style="padding:15px; text-align:center;">
                                <button type="button" class="btn-map" onclick="window.open('${lap[3]}','_blank')"><i class="fas fa-map-marked-alt"></i></button>
                                <button type="button" class="btn-pro" onclick="updateKeSheets(${realID}, 'Proses')"><i class="fas fa-hard-hat"></i></button>
                                <button type="button" class="btn-done" onclick="updateKeSheets(${realID}, 'Selesai')"><i class="fas fa-check-circle"></i></button>
                                <button type="button" class="btn-del" onclick="hapusDariSheets(${realID})"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                });
            } catch (e) { tbody.innerHTML = "<tr><td colspan='5'>Gagal muat data. Cek koneksi internet.</td></tr>"; }
        }

        // 3. FUNGSI AKSI (WAJIB ADA AGAR TOMBOL BEKERJA)
        async function updateKeSheets(id, status) {
            if(!confirm("Ubah status laporan ke " + status + "?")) return;
            // Gunakan mode no-cors untuk bypass Google Apps Script security
            await fetch(`${SAKTI}?action=update&id=${id}&status=${status}`, { method: 'POST', mode: 'no-cors' });
            alert("‚úÖ Perintah Terkirim!");
            setTimeout(loadLaporan, 2000); // Reload otomatis setelah 2 detik
        }

        async function hapusDariSheets(id) {
            if(!confirm("‚ö†Ô∏è Hapus laporan baris #" + id + " secara permanen?")) return;
            await fetch(`${SAKTI}?action=delete&id=${id}`, { method: 'POST', mode: 'no-cors' });
            alert("üóëÔ∏è Laporan Dihapus!");
            setTimeout(loadLaporan, 2000);
        }

        window.onload = loadLaporan;
    </script>
</body>
</html>